# MIRDC 每日平均溫度爬蟲

## 📋 專案概述

本專案用於從氣象資料庫中提取各測站溫度數據，進行統計計算，並將結果存儲到 `position_status` 表中的定時排程。
執行時間為每天早上6:15分，針對昨天早上6:00 ~ 當天早上6:00這24小時的溫度資料進行處理。

**主要功能：**
- ✅ 獲取各測站近 24 小時溫度資料
- ✅ 計算平均溫度、最高溫度、最低溫度
- ✅ 計算權重溫度（基於歷史 7 日數據）
- ✅ 計算誤差調整後溫度
- ✅ 自動新增或更新數據庫記錄
- ✅ 完整的日誌記錄系統

---

## 🏗️ 專案結構

```
MIRDC_Daily_Avg_Temp/
├── main.py                          # 主程式入口
├── config/
│   ├── settings.py                  # 資料庫配置
│   └── logger.py                    # 日誌配置
├── core/
│   ├── Database.py                  # 資料庫操作類
│   └── Station.py                   # 測站數據處理類
├── utils/
│   └── load_stations.py             # 測站資料載入
├── logs/                            # 日誌輸出目錄
└── README.md                        # 本檔案
```

---

## 📦 依賴環境

```
Python >= 3.8
PyMySQL >= 1.0.0
```

### 安裝依賴

```bash
pip install -r requirements.txt
```

若無 requirements.txt，可手動安裝：

```bash
pip install PyMySQL
```

---

## ⚙️ 配置說明

### 1. 資料庫配置 (`config/settings.py`)

編輯 `config/settings.py`，設定資料庫連線資訊：

```python
DATABASE_CONFIG = {
    'host': 'localhost',
    'port': 3306,
    'user': 'your_username',
    'password': 'your_password',
    'database': 'your_database',
    'charset': 'utf8mb4'
}
```

### 2. 日期設定 (`main.py`)

在 `main.py` 中設定處理日期：

```python
# 使用當前日期
date = datetime.now().date()

# 或指定特定日期
# date = "2025-11-20"
```

---

## 🚀 使用方法

### 執行程式

```bash
python main.py
```

### 程式流程

```
1. 載入所有測站資訊
2. 對每個測站執行以下操作：
   ├─ 獲取近 24 小時溫度資料
   ├─ 計算平均溫度 (avg_temp)
   ├─ 計算最高/最低溫度 (max_temp, min_temp)
   ├─ 計算權重溫度 (weight_temp)
   ├─ 計算誤差調整後溫度 (adjusted_temp)
   └─ 新增或更新到 position_status 表
3. 程式完成
```

---

## 📊 核心邏輯說明

### 溫度計算方法

#### 1. 平均溫度 (avg_temp)
```
平均溫度 = 近24小時所有溫度之和 / 資料筆數
```

#### 2. 權重溫度 (weight_temp)
使用時間序列加權平均，最新數據權重最高：
```
權重溫度 = (T₁×1 + T₂×2 + ... + T₇×7) / (1+2+...+7)
其中 T₁ 為最早資料，T₇ 為最新資料
```

#### 3. 調整後溫度 (adjusted_temp)

計算邏輯如下：

| 條件 | 處理方式 |
|------|--------|
| 無前次溫度資料 | 使用當前平均溫度 |
| 無當前溫度資料 | 使用前次溫度 |
| 溫度不在 0~60°C | 使用前次溫度 |
| 與前次溫度差 > 5°C | 取平均：(前次 + 當前) / 2 |
| 其他情況 | 使用當前平均溫度 |

---

## 📝 資料庫表結構

### position_status 表

| 欄位 | 類型 | 說明 |
|------|------|------|
| id | INT | 主鍵 |
| station | VARCHAR | 測站名稱 |
| date | DATE | 資料日期 |
| temp | DECIMAL | 平均溫度 |
| adjusted_temp | DECIMAL | 調整後溫度 |
| weight_temp | DECIMAL | 權重溫度 |
| max_Temp | DECIMAL | 最高溫度 |
| min_Temp | DECIMAL | 最低溫度 |
| pressure | DECIMAL | 平均氣壓 |
| city | VARCHAR | 縣市 |

**主鍵：** `(station, date)`（同一測站同一日期只有一筆記錄）

---

## 📋 日誌系統

### 日誌位置
```
logs/app_YYYYMMDD.log
```

### 日誌級別

| 級別 | 標記 | 說明 | 範例 |
|------|------|------|------|
| DEBUG | 🔍 | 除錯訊息 | 前次溫度資料、準備新增資料 |
| INFO | ℹ️ | 一般訊息 | 連線成功、計算結果、更新完成 |
| WARNING | ⚠️ | 警告訊息 | 缺失資料、異常溫度 |
| ERROR | ❌ | 錯誤訊息 | 連線失敗、保存失敗 |

### 日誌範例

```
[2025-11-22 04:02:32] [INFO] [core.Database] 資料庫連線建立成功
[2025-11-22 04:02:33] [INFO] [__main__] 程式開始執行，共有 5 個測站
[2025-11-22 04:02:33] [INFO] [__main__] ==================================================
[2025-11-22 04:02:33] [INFO] [__main__] 處理測站: 臺北 (ID: 466910)
[2025-11-22 04:02:34] [INFO] [core.Station] 平均溫度: 23.5
[2025-11-22 04:02:34] [INFO] [core.Station] 權重溫度: 23.2
[2025-11-22 04:02:35] [INFO] [core.Database] 已更新 position_status: 臺北 - 2025-11-22
[2025-11-22 04:02:35] [INFO] [__main__] 程式執行完成
```

---

## ⚠️ 注意事項

1. **溫度資料範圍**：系統會過濾 0~60°C 範圍外的異常資料
2. **時區設定**：確保數據庫和系統時區一致
3. **權重溫度計算**：需要至少 1 筆歷史資料，無資料時可能為 0
4. **資料庫連線**：每次執行都會建立新連線，不使用連線池
5. **日期格式**：支援 `datetime.date` 物件或 "YYYY-MM-DD" 字符串

---

## 📄 更新日誌

### v1.0.0 (2025-11-22)
- ✅ 初始版本發布
- ✅ 完成溫度計算功能
- ✅ 實現數據庫新增/更新功能
- ✅ 建立完整的日誌系統

---

**最後更新：2025-11-22**
